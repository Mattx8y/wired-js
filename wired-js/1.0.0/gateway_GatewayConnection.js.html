

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      gateway/GatewayConnection.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      Braintree SDK Client Reference
    </h3>

    

    <h3>Classes</h3><ul><li id="Client-nav"><a href="Client.html">Client</a><ul class='methods'><li data-type="method" id="Client-login-nav"><a href="Client.html#login">login</a></li></ul></li><li id="Guild-nav"><a href="Guild.html">Guild</a></li><li id="GuildEmoji-nav"><a href="GuildEmoji.html">GuildEmoji</a></li><li id="Permissions-nav"><a href="Permissions.html">Permissions</a><ul class='methods'><li data-type="method" id="Permissions-has-nav"><a href="Permissions.html#has">has</a></li></ul></li><li id="Role-nav"><a href="Role.html">Role</a></li><li id="ShardManager-nav"><a href="ShardManager.html">ShardManager</a><ul class='methods'><li data-type="method" id="ShardManager-start-nav"><a href="ShardManager.html#start">start</a></li></ul></li><li id="User-nav"><a href="User.html">User</a></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#GuildDefaultMessageNotificationLevel">GuildDefaultMessageNotificationLevel</a></li><li><a href="global.html#GuildExplicitContentFilterLevel">GuildExplicitContentFilterLevel</a></li><li><a href="global.html#GuildMFALevels">GuildMFALevels</a></li><li><a href="global.html#GuildSystemChannelFlags">GuildSystemChannelFlags</a></li><li><a href="global.html#GuildVerificationLevel">GuildVerificationLevel</a></li><li><a href="global.html#Intents">Intents</a></li><li><a href="global.html#PermissionFlags">PermissionFlags</a></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        gateway/GatewayConnection.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>const EventEmitter = require("events");
const {URL} = require("url");

const WebSocket = require("ws");

const packageInfo = require("../../package.json");

let erlpack;
let zlib;
try {
  erlpack = require("erlpack");
} catch(err) {}
try {
  zlib = require("zlib-sync");
} catch(err) {}

/**
 * Base data for a packet
 * @typedef {Object} Packet
 * @property {number} op The OPCode of the packet
 * @property {*} d The packet data
 * @property {?string} t The name of the packet (if OPCode 0)
 * @property {?s} The sequence number (if OPCode 0)
 * @private
 */

/**
 * Manages gateway connections
 * @private
 */
class GatewayConnection extends EventEmitter {
  /**
   * Creates a GatewayConnection
   * @param {string} token The client's token.
   * @param {Intents[]} intents The client's intents
   */
  constructor(token, intents) {
    super();

    /**
     * The token used to connect to the gateway
     * @type {string}
     * @private
     */
    this.token = token;

    /**
     * The zlib inflate used for compression
     * @type {?ZlibSyncInflate}
     * @private
     */
    if (zlib) this.inflate = new zlib.Inflate({
      chunkSize: 65535,
      flush: zlib.Z_SYNC_FLUSH,
      to: erlpack ? "" : "string",
    });

    /**
     * Packs a packet to send
     * @method
     * @param {Object} data The data to pack
     * @returns {string|*} The packed data
     * @private
     */
    this.pack = erlpack ? erlpack.pack : JSON.stringify;

    /**
     * The intents for the gateway
     * @type {number}
     * @private
     */
    this.intents = intents.reduce((a, b) => a | b);
    
    let url = new URL(process.env.GATEWAY_URL);
    url.searchParams.set("v", 8);
    url.searchParams.set("encoding", erlpack ? "etf" : "json");
    if (zlib) url.searchParams.set("compress", "zlib-stream");
    
    /**
     * The URL to connect to the gateway with
     * @type {string}
     * @priavte
     */
    this.gatewayURL = url.href;
  }
  
  /**
   * Connect to the gateway
   * @param {boolean} [resume=false] Whether or not to resume a previous session.
   * @private
   */
  login(resume = false) {
    /**
     * Whether or not the connection is resuming
     * @type {boolean}
     * @private
     */
    this.resume = resume &amp;&amp; this.seq &amp;&amp; this.sessionID;
    
    /**
     * The WebSocket for the gateway connection
     * @type {WebSocket}
     * @private
     */
    this.socket = new WebSocket(this.gatewayURL);
    
    this.socket.on("message", this.onPacket.bind(this));
  }
  
  /**
   * Handle a packet
   * @param {*} data The raw data of the packet
   * @private
   */
  onPacket(data) {
    if (zlib) {
      if (data instanceof ArrayBuffer) data = new Uint8Array(data);
      const flush = data.length >= 4 &amp;&amp; data[data.length - 4] === 0x00 &amp;&amp; data[data.length - 3] === 0x00 &amp;&amp; data[data.length - 2] === 0xff &amp;&amp; data[data.length - 1] === 0xff;
      this.inflate.push(data, flush &amp;&amp; zlib.Z_SYNC_FLUSH);
      if (!flush) return;
      data = this.inflate.result;
    }
    if (erlpack) {
      if (!Buffer.isBuffer(data)) data = Buffer.from(new Uint8Array(data));
      if (data.length == 0) return;
      data = erlpack.unpack(data);
    } else {
      data = JSON.parse(data);
    }
    
    switch (data.op) {
      case 0:
        this.onDispatch(data);
        break;
      case 7:
        this.onReconnect(data);
        break;
      case 9:
        this.onInvalidSession(data);
        break;
      case 10:
        this.onHello(data);
        break;
      case 11:
        this.onHeartbeatACK(data);
        break;
    }
  }
  
  /**
   * Handle a reconnect payload
   * @fires GatewayConnection#RECONNECT
   * @private
   */
  onReconnect() {
    /**
     * Emitted when the client recieves an OPCode 7 RECONNECT payload
     * @event GatewayConnection#RECONNECT
     * @private
     */
    this.emit("RECONNECT");
    this.disconnect(true);
    this.login(true);
  }
  
  /**
   * Handle an invalid session payload
   * @param {Packet} data The packet data
   * @fires GatewayConnection#INVALID_SESSION
   * @private
   */
  onInvalidSession(data) {
    /**
     * Emitted when the client recieves an OPCode 9 INVALID_SESSION payload
     * @event GatewayConnection#INVALID_SESSION
     * @param {boolean} canResume Whether or not the client can resume
     * @private
     */
    this.emit("INVALID_SESSION", data.d);
    this.disconnect(data.d);
    this.login(data.d);
  }
  
  /**
   * Handle a hello payload
   * @param {Packet} data The packet data
   * @fires GatewayConnection#HELLO
   * @private
   */
  onHello(data) {
    /**
     * Emitted when the client recieves an OPCode 10 HELLO payload
     * @event GatewayConnection#HELLO
     * @param {Object} data The heartbeat data
     * @param {string} data.heartbeat_interval The heartbeat interval in milliseconds
     * @private
     */
    this.emit("HELLO", data.d);

    /**
     * The heartbeat interval
     * @type {Interval}
     * @private
     */
    this.heartbeatInterval = setInterval(this.heartbeat.bind(this), data.d.heartbeat_interval);

    /**
     * Whether or not the client has recieved OPCode 11 HEARTBEAT_ACK
     * @type {boolean}
     * @private
     */
    this.hasRecievedACK = true;

    if (this.resume) return this.resume();
    this.identify();
  }
  
  /**
   * Handle a heartbeat ACK payload
   * @fires GatewayConnection#HEARTBEAT_ACK
   * @private
   */
  onHeartbeatACK() {
    /**
     * Emitted when the client recieves an OPCode 11 HEARTBEAT_ACK
     * @event GatewayConnection#HEARTBEAT_ACK
     * @private
     */
    this.emit("HEARTBEAT_ACK");
    this.hasRecievedACK = true;
  }
  
  /**
   * Handle a dispatch payload
   * @param {Packet} data The packet data
   * @private
   */
  onDispatch(data) {
    this.emit(data.t, data.d);
    /**
     * The current sequence number
     * @type {number}
     * @private
     */
    this.seq = data.s;

    /**
     * The session ID
     * @type {string}
     * @private
     */
    if (data.t === "READY") this.sessionID = data.d.session_id;
  }
  
  /**
   * Sends a heartbeat payload
   * @private
   */
  heartbeat() {
    if (this.hasRecievedACK) {
      this.hasRecievedACK = false;
      this.socket.send(this.pack({
        op: 1,
        d: this.seq || null
      }));
    } else {
      this.disconnect(true);
      this.login(true);
    }
  }
  
  /**
   * Sends an identify payload
   * @private
   */
  identify() {
    this.socket.send(this.pack({
      op: 2,
      d: {
        token: this.token,
        properties: {
          $os: process.platform,
          $browser: packageInfo.name,
          $device: packageInfo.name
        },
        compress: !!zlib,
        shard: [parseInt(process.env.SHARD_ID || 0), parseInt(process.env.SHARD_COUNT || 1)],
        intents: this.intents
      }
    }));
  }
  
  /**
   * Sends a resume payload
   * @private
   */
  resume() {
    this.resume = false;
    this.socket.send(this.pack({
      op: 6,
      d: {
        token: this.token,
        session_id: this.sessionID,
        seq: this.seq
      }
    }))
  }
  
  /**
   * Disconnects from the gateway
   * @param {boolean} [resume=false] Whether or not to resume the connection.
   * @private
   */
  disconnect(resume = false) {
    this.socket.close(4000);
    clearInterval(this.heartbeatInterval);
    this.heartbeatInterval = null;
    this.socket = null;
    if (!resume) {
      this.seq = null;
      this.sessionID = null;
    }
  }
}

module.exports = GatewayConnection;</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
