<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>gateway/GatewayConnection.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Client.html">Client</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Client.html#login">login</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Guild.html">Guild</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Permissions.html">Permissions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Permissions.html#has">has</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Role.html">Role</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="ShardManager.html">ShardManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="ShardManager.html#start">start</a></span></li><li class="nav-heading">Events</li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Client.html#event:guildAvailable">guildAvailable</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Client.html#event:guildCreate">guildCreate</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Client.html#event:guildDelete">guildDelete</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Client.html#event:guildUnavailable">guildUnavailable</a></span></li><li class="nav-heading"><span class="nav-item-type type-event">E</span><span class="nav-item-name"><a href="Client.html#event:guildUpdate">guildUpdate</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#GuildDefaultMessageNotificationLevel">GuildDefaultMessageNotificationLevel</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#GuildExplicitContentFilterLevel">GuildExplicitContentFilterLevel</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#GuildVerificationLevel">GuildVerificationLevel</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#Intents">Intents</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#PermissionFlags">PermissionFlags</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">gateway/GatewayConnection.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const EventEmitter = require("events");
const {URL} = require("url");

const WebSocket = require("ws");

const packageInfo = require("../../package.json");

let erlpack;
let zlib;
try {
  erlpack = require("erlpack");
} catch(err) {}
try {
  zlib = require("zlib-sync");
} catch(err) {}

/**
 * Base data for a packet
 * @typedef {Object} Packet
 * @property {number} op The OPCode of the packet
 * @property {*} d The packet data
 * @property {?string} t The name of the packet (if OPCode 0)
 * @property {?s} The sequence number (if OPCode 0)
 * @private
 */

/**
 * Manages gateway connections
 * @private
 */
class GatewayConnection extends EventEmitter {
  /**
   * Creates a GatewayConnection
   * @param {string} token The client's token.
   * @param {Intents[]} intents The client's intents
   */
  constructor(token, intents) {
    super();

    /**
     * The token used to connect to the gateway
     * @type {string}
     * @private
     */
    this.token = token;

    /**
     * The zlib inflate used for compression
     * @type {?ZlibSyncInflate}
     * @private
     */
    if (zlib) this.inflate = new zlib.Inflate({
      chunkSize: 65535,
      flush: zlib.Z_SYNC_FLUSH,
      to: erlpack ? "" : "string",
    });

    /**
     * Packs a packet to send
     * @method
     * @param {Object} data The data to pack
     * @returns {string|*} The packed data
     * @private
     */
    this.pack = erlpack ? erlpack.pack : JSON.stringify;

    /**
     * The intents for the gateway
     * @type {number}
     * @private
     */
    this.intents = intents.reduce((a, b) => a | b);
    
    let url = new URL(process.env.GATEWAY_URL);
    url.searchParams.set("v", 8);
    url.searchParams.set("encoding", erlpack ? "etf" : "json");
    if (zlib) url.searchParams.set("compress", "zlib-stream");
    
    /**
     * The URL to connect to the gateway with
     * @type {string}
     * @priavte
     */
    this.gatewayURL = url.href;
  }
  
  /**
   * Connect to the gateway
   * @param {boolean} [resume=false] Whether or not to resume a previous session.
   * @private
   */
  login(resume = false) {
    /**
     * Whether or not the connection is resuming
     * @type {boolean}
     * @private
     */
    this.resume = resume &amp;&amp; this.seq &amp;&amp; this.sessionID;
    
    /**
     * The WebSocket for the gateway connection
     * @type {WebSocket}
     * @private
     */
    this.socket = new WebSocket(this.gatewayURL);
    
    this.socket.on("message", this.onPacket.bind(this));
  }
  
  /**
   * Handle a packet
   * @param {*} data The raw data of the packet
   * @private
   */
  onPacket(data) {
    if (zlib) {
      if (data instanceof ArrayBuffer) data = new Uint8Array(data);
      const flush = data.length >= 4 &amp;&amp; data[data.length - 4] === 0x00 &amp;&amp; data[data.length - 3] === 0x00 &amp;&amp; data[data.length - 2] === 0xff &amp;&amp; data[data.length - 1] === 0xff;
      this.inflate.push(data, flush &amp;&amp; zlib.Z_SYNC_FLUSH);
      if (!flush) return;
      data = this.inflate.result;
    }
    if (erlpack) {
      if (!Buffer.isBuffer(data)) data = Buffer.from(new Uint8Array(data));
      if (data.length == 0) return;
      data = erlpack.unpack(data);
    } else {
      data = JSON.parse(data);
    }
    
    switch (data.op) {
      case 0:
        this.onDispatch(data);
        break;
      case 7:
        this.onReconnect(data);
        break;
      case 9:
        this.onInvalidSession(data);
        break;
      case 10:
        this.onHello(data);
        break;
      case 11:
        this.onHeartbeatACK(data);
        break;
    }
  }
  
  /**
   * Handle a reconnect payload
   * @fires GatewayConnection#RECONNECT
   * @private
   */
  onReconnect() {
    /**
     * Emitted when the client recieves an OPCode 7 RECONNECT payload
     * @event GatewayConnection#RECONNECT
     * @private
     */
    this.emit("RECONNECT");
    this.disconnect(true);
    this.login(true);
  }
  
  /**
   * Handle an invalid session payload
   * @param {Packet} data The packet data
   * @fires GatewayConnection#INVALID_SESSION
   * @private
   */
  onInvalidSession(data) {
    /**
     * Emitted when the client recieves an OPCode 9 INVALID_SESSION payload
     * @event GatewayConnection#INVALID_SESSION
     * @param {boolean} canResume Whether or not the client can resume
     * @private
     */
    this.emit("INVALID_SESSION", data.d);
    this.disconnect(data.d);
    this.login(data.d);
  }
  
  /**
   * Handle a hello payload
   * @param {Packet} data The packet data
   * @fires GatewayConnection#HELLO
   * @private
   */
  onHello(data) {
    /**
     * Emitted when the client recieves an OPCode 10 HELLO payload
     * @event GatewayConnection#HELLO
     * @param {Object} data The heartbeat data
     * @param {string} data.heartbeat_interval The heartbeat interval in milliseconds
     * @private
     */
    this.emit("HELLO", data.d);

    /**
     * The heartbeat interval
     * @type {Interval}
     * @private
     */
    this.heartbeatInterval = setInterval(this.heartbeat.bind(this), data.d.heartbeat_interval);

    /**
     * Whether or not the client has recieved OPCode 11 HEARTBEAT_ACK
     * @type {boolean}
     * @private
     */
    this.hasRecievedACK = true;

    if (this.resume) return this.resume();
    this.identify();
  }
  
  /**
   * Handle a heartbeat ACK payload
   * @fires GatewayConnection#HEARTBEAT_ACK
   * @private
   */
  onHeartbeatACK() {
    /**
     * Emitted when the client recieves an OPCode 11 HEARTBEAT_ACK
     * @event GatewayConnection#HEARTBEAT_ACK
     * @private
     */
    this.emit("HEARTBEAT_ACK");
    this.hasRecievedACK = true;
  }
  
  /**
   * Handle a dispatch payload
   * @param {Packet} data The packet data
   * @private
   */
  onDispatch(data) {
    this.emit(data.t, data.d);
    /**
     * The current sequence number
     * @type {number}
     * @private
     */
    this.seq = data.s;

    /**
     * The session ID
     * @type {string}
     * @private
     */
    if (data.t === "READY") this.sessionID = data.d.session_id;
  }
  
  /**
   * Sends a heartbeat payload
   * @private
   */
  heartbeat() {
    if (this.hasRecievedACK) {
      this.hasRecievedACK = false;
      this.socket.send(this.pack({
        op: 1,
        d: this.seq || null
      }));
    } else {
      this.disconnect(true);
      this.login(true);
    }
  }
  
  /**
   * Sends an identify payload
   * @private
   */
  identify() {
    this.socket.send(this.pack({
      op: 2,
      d: {
        token: this.token,
        properties: {
          $os: process.platform,
          $browser: packageInfo.name,
          $device: packageInfo.name
        },
        compress: !!zlib,
        shard: [parseInt(process.env.SHARD_ID || 0), parseInt(process.env.SHARD_COUNT || 1)],
        intents: this.intents
      }
    }));
  }
  
  /**
   * Sends a resume payload
   * @private
   */
  resume() {
    this.resume = false;
    this.socket.send(this.pack({
      op: 6,
      d: {
        token: this.token,
        session_id: this.sessionID,
        seq: this.seq
      }
    }))
  }
  
  /**
   * Disconnects from the gateway
   * @param {boolean} [resume=false] Whether or not to resume the connection.
   * @private
   */
  disconnect(resume = false) {
    this.socket.close(4000);
    clearInterval(this.heartbeatInterval);
    this.heartbeatInterval = null;
    this.socket = null;
    if (!resume) {
      this.seq = null;
      this.sessionID = null;
    }
  }
}

module.exports = GatewayConnection;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Tue Nov 24 2020 16:40:11 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
